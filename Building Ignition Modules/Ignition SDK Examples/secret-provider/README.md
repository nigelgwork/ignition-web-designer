# Secret Provider

This module provides an example implementation of the `SecretProvider` interface, which allows for the use of stored 
secrets by Ignition. It is backed by a MongoDB backend, and the secrets are expected to be stored in the MongoDB 
database as the JSON returned from `SystemEncryptionService.entryToJson(Plaintext)`.

In a production environment, you may want to use the MongoDB Connector module, but for simplicity, this module uses the
MongoDB Java driver directly. This allows for easy testing without the need to add another module to Ignition.

This implementation is set up for easy testing, and the default configuration should connect to a local, unsecured
MongoDB. To start one in a Docker container, run:

```bash
docker run -d -p 27017:27017 --rm --name insecure-mongo mongo
```

Should you wish to start a MongoDB instance requiring authentication, you can use the following command.  Remember
to replace `admin` and `secret` with your desired username and password and configure your secret provider to use these
credentials.

```bash
docker run -d -p 27017:27017 --rm --name secure-mongo \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=secret \
  mongo
```

## Adding Secrets to MongoDB

Since there is currently no write method for SecretProvider, you will need to populate the database with secrets 
manually.

### Encrypting Secrets
First, generate a secret calling the Ignition system encryption REST API. Your API token will need to have Gateway
write permissions, and you will need to replace `password` with the secret you want to encrypt.

```bash
curl -s -H "Content-Type: text/plain" -H "X-Ignition-API-Token: ${API_TOKEN}" \
  http://localhost:8088/data/api/v1/encryption/encrypt -d password | json_pp
```

Which will result in a response similar to the following:

```json
{
  "ciphertext" : "NhkoviQxLsUZ2g",
  "encrypted_key" : "fYxDhnE_nKXiWGwGBJVaEWhojeg7duY3Y3G4dF89sKdjuf5iiX2nKw",
  "iv" : "TTGQPncN-rlf70Bq",
  "protected" : "eyJhbGciOiJBMjU2S1ciLCJlbmMiOiJBMjU2R0NNIiwiaWF0IjoxNzU1NjM0NDg3LCJ6aXAiOiJERUYifQ",
  "tag" : "sMU9-vhCyWHxLCH190eQ3A"
}
```

### Inserting Secrets into MongoDB

Next, you will need to insert the encrypted secret into the MongoDB database using Mongo shell or a MongoDB client:

```bash
mongosh mongodb://localhost:27017/secrets_db
```

or if you are using a secure MongoDB instance with authentication:

```bash
mongosh mongodb://localhost:27017/secrets_db -u admin -p password --authenticationDatabase admin
```

Press `Enter` to connect to the database, then run the following command to insert the secret, replacing the 
`secretname` with the name of your secret and the `ciphertext` with the actual ciphertext generated by the Ignition
REST API:

```javascript
secrets_db> db.mycollection.insertOne({
   "name": "secretname",
   "ciphertext": {
       "ciphertext" : "NhkoviQxLsUZ2g",
       "encrypted_key" : "fYxDhnE_nKXiWGwGBJVaEWhojeg7duY3Y3G4dF89sKdjuf5iiX2nKw",
       "iv" : "TTGQPncN-rlf70Bq",
       "protected" : "eyJhbGciOiJBMjU2S1ciLCJlbmMiOiJBMjU2R0NNIiwiaWF0IjoxNzU1NjM0NDg3LCJ6aXAiOiJERUYifQ",
       "tag" : "sMU9-vhCyWHxLCH190eQ3A"
   }
 })
```
